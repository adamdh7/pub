<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>Pub.Adam_D'H7</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            overflow: hidden;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            overscroll-behavior: none;
        }

        #ad-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.2s ease;
        }

        #ad-container.shrink {
            transform: scale(0.95);
        }

        video, img {
            max-width: 100%;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        #close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            cursor: default;
            border: 2px solid white;
            z-index: 10;
        }

        #close-btn.clickable {
            cursor: pointer;
            background: #333333;
            font-size: 20px;
        }

        #sound-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid white;
            z-index: 10;
            cursor: pointer;
        }

        #cta-btn {
            position: absolute;
            bottom: 60px;
            background-color: #333333;
            color: white;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            text-decoration: none;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            display: none;
            z-index: 10;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        #cta-btn:active {
            transform: scale(0.95);
        }

        #progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background: #2c2c2c;
            pointer-events: none;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: #bdc3c7;
            transition: width 0.1s linear;
        }
    </style>
</head>
<body>

    <div id="ad-container">
        <div id="close-btn"></div>
        <div id="sound-btn"></div>
        
        <div id="media-wrapper"></div>

        <a id="cta-btn" href="#">Click Here</a>
        
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
    </div>

    <script>
        const translations = {
            fr: "Cliquez ici",
            es: "Haz clic aqu√≠",
            en: "Click here"
        };

        const mutedSVG = '<svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 0 24 24" width="32" fill="white"><path d="M0 0h24v24H0z" fill="none"/><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>';

        const unmutedSVG = '<svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 0 24 24" width="32" fill="white"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.73 2.5-2.25 2.5-4.03zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>';

        const availableLangs = ['fr', 'es', 'en'];
        const defaultLang = 'en';

        const container = document.getElementById('ad-container');
        const mediaWrapper = document.getElementById('media-wrapper');
        const closeBtn = document.getElementById('close-btn');
        const soundBtn = document.getElementById('sound-btn');
        const ctaBtn = document.getElementById('cta-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');

        closeBtn.style.display = 'none';
        soundBtn.style.display = 'none';
        progressContainer.style.display = 'none';

        ctaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const url = this.getAttribute('href');
            if (url && url !== '#') {
                const newWin = window.open(url, '_blank');
                if (!newWin || newWin.closed || typeof newWin.closed === 'undefined') {
                    window.location.href = url;
                }
            }
        });

        function showOverlays(isVideo) {
            closeBtn.style.display = 'flex';
            soundBtn.style.display = isVideo ? 'flex' : 'none';
            if (ctaBtn.hasAttribute('href') && ctaBtn.getAttribute('href') !== '#') {
                ctaBtn.style.display = 'block';
            }
            progressContainer.style.display = isVideo ? 'block' : 'none';
        }

        function getLanguage() {
            const userLang = navigator.language || navigator.userLanguage; 
            const shortLang = userLang.split('-')[0]; 
            return availableLangs.includes(shortLang) ? shortLang : defaultLang;
        }

        async function loadContent() {
            const lang = getLanguage();
            let data = [];

            try {
                const response = await fetch(`${lang}.json`);
                if (!response.ok) throw new Error();
                data = await response.json();
            } catch (e) {
                try {
                    const response = await fetch(`fr.json`);
                    data = await response.json();
                } catch (err) {
                    return;
                }
            }

            if (data && data.length > 0) {
                const item = data[Math.floor(Math.random() * data.length)];
                renderContent(item, lang);
            }
        }

        function renderContent(item, lang) {
            if (item.link) {
                ctaBtn.href = item.link;
                ctaBtn.textContent = translations[lang];
            } else {
                ctaBtn.removeAttribute('href');
            }

            const videoExtensions = ['.mp4','.mov','.mkv','.webm','.avi','.ogg','.flv','.wmv','.3gp','.m4v','.mpg','.mpeg'];
            const isVideo = item.type === 'video' || videoExtensions.some(ext => item.url.toLowerCase().endsWith(ext));

            mediaWrapper.innerHTML = '';

            if (isVideo) {
                setupVideo(item);
            } else {
                setupImage(item);
            }
        }

        function setupVideo(item) {
            const video = document.createElement('video');
            video.src = item.url;
            video.autoplay = true;
            video.playsInline = true;
            video.muted = true;
            video.controls = false;
            video.preload = 'auto';

            mediaWrapper.appendChild(video);

            function updateSoundIcon() {
                soundBtn.innerHTML = video.muted ? mutedSVG : unmutedSVG;
            }

            updateSoundIcon();

            let overlaysShown = false;

            video.addEventListener('playing', () => {
                if (!overlaysShown) {
                    window.parent.postMessage('video_playing', '*');
                    showOverlays(true);
                    updateSoundIcon();
                    if (video.duration && !isNaN(video.duration)) {
                        const initialTimeLeft = Math.ceil(video.duration - video.currentTime);
                        closeBtn.innerText = initialTimeLeft + "s";
                    }
                    overlaysShown = true;
                }
            });

            video.ontimeupdate = () => {
                const percent = video.duration ? (video.currentTime / video.duration) * 100 : 0;
                progressBar.style.width = percent + "%";

                const timeLeft = video.duration ? Math.ceil(video.duration - video.currentTime) : 0;
                if (timeLeft > 0) {
                    closeBtn.innerText = timeLeft + "s";
                }
            };

            video.onended = () => {
                activateCloseButton();
                progressBar.style.width = "100%";
            };

            video.play().catch(() => {});

            const unlockAudio = () => {
                video.muted = false;
                video.play().catch(() => {});
                updateSoundIcon();
                document.body.removeEventListener('click', unlockAudio);
                document.body.removeEventListener('touchstart', unlockAudio);
            };

            document.body.addEventListener('click', unlockAudio);
            document.body.addEventListener('touchstart', unlockAudio);

            soundBtn.onclick = (e) => {
                e.stopPropagation();
                video.muted = !video.muted;
                if (!video.muted) {
                    video.play().catch(() => {});
                }
                updateSoundIcon();
            };

            const shrinkStart = () => container.classList.add('shrink');
            const shrinkEnd = () => container.classList.remove('shrink');

            video.addEventListener('mousedown', shrinkStart);
            video.addEventListener('mouseup', shrinkEnd);
            video.addEventListener('touchstart', shrinkStart);
            video.addEventListener('touchend', shrinkEnd);
        }

        function setupImage(item) {
            const img = document.createElement('img');
            img.src = item.url;
            mediaWrapper.appendChild(img);

            img.onload = () => {
                window.parent.postMessage('image_displayed', '*');
                showOverlays(false);
                let timeLeft = 3;
                closeBtn.innerText = timeLeft + "s";

                const timer = setInterval(() => {
                    timeLeft--;
                    if (timeLeft > 0) {
                        closeBtn.innerText = timeLeft + "s";
                    } else {
                        clearInterval(timer);
                        activateCloseButton();
                    }
                }, 1000);
            };
        }

        function activateCloseButton() {
            closeBtn.innerHTML = "&times;";
            closeBtn.classList.add("clickable");
            
            closeBtn.onclick = () => {
                window.parent.postMessage('close', '*');

                if (document.referrer) {
                    history.back();
                } else {
                    window.close();
                }
            };
        }

        document.addEventListener('touchmove', function (e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (e) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, true);

        document.addEventListener('keydown', function (e) {
            if (e.keyCode === 116) {
                e.preventDefault();
            }
            if (e.ctrlKey && (e.keyCode === 82 || e.keyCode === 114)) {
                e.preventDefault();
            }
            if (e.ctrlKey && (e.keyCode === 87)) {
                e.preventDefault();
            }
        });

        window.addEventListener('beforeunload', function (e) {
            e.preventDefault();
            e.returnValue = '';
        });

        loadContent();
    </script>
</body>
</html>
